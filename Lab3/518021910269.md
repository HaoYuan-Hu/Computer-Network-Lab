### Lab3 Qos

姓名：胡昊源  

学号：518021910269

#### 优化目标

1、flow0 达到指定带宽

flow0 指定带宽 1.28Gbps = 160,000,000Bps

模拟总时间为10 * 1,000,000ns = 0.01s

所以输出结果中 flow0 的 pass 要接近1,600,000，

2、每个 flow 的带宽分配达到指定比例

其他 flow 要与 flow0 达成 8：4：2：1 的比例



#### 针对 srTCM 的测试

**大的 cbs 和 ebs**

参数如下所示：

| flow_id | cir       | cbs    | ebs     |
| ------- | --------- | ------ | ------- |
| 0       | 160000000 | 640000 | 1728000 |
| 1       | 80000000  | 320000 | 864000  |
| 2       | 40000000  | 160000 | 432000  |
| 3       | 20000000  | 80000  | 216000  |

cir 最大为 1280000000 / 8 = 160000000，

flow_id[0] = 160000000，

flow_id[n] 按照 8：4：2：1 的比例依次减少，

结果如下所示：

![image-20210409212935268](C:\Users\荣耀\Desktop\云计算系统设计与开发\Computer-Network-Lab\Lab3\518021910269.assets\image-20210409212935268.png)

结论：cbs 和 ebs 成倍减少，其通过个数也成相应的倍数减少，例 fid2 和 fid3 相比，前者通过个数大约是后者两倍。



**小的 cbs 和 ebs**

参数如下所示：

| flow_id | cir       | cbs   | ebs    |
| ------- | --------- | ----- | ------ |
| 0       | 160000000 | 64000 | 172800 |
| 1       | 80000000  | 32000 | 86400  |
| 2       | 40000000  | 16000 | 43200  |
| 3       | 20000000  | 8000  | 21600  |

结果如下所示：

![image-20210409213049362](C:\Users\荣耀\Desktop\云计算系统设计与开发\Computer-Network-Lab\Lab3\518021910269.assets\image-20210409213049362.png)

结论：cbs 和 ebs 被调低一个数量级，在 fid1 丢包更多，可能是因为 cbs 和 ebs 的降低，使得被标记为红色的包数量增多，从而丢包变多。



#### 针对 WRED 的测试

**策略一：绿色、黄色包全部进入队列，红色包全部丢掉**

参数如下所示：

| color  | min_th | max_th | mxp_inv |
| ------ | ------ | ------ | ------- |
| GREEN  | 1022   | 1023   | 10      |
| YELLOW | 1022   | 1023   | 10      |
| RED    | 0      | 1      | 10      |

结果如下所示：

![image-20210409223251810](C:\Users\荣耀\Desktop\云计算系统设计与开发\Computer-Network-Lab\Lab3\518021910269.assets\image-20210409223251810.png)



**策略二：绿色、黄色包部分进入队列，红色包全部丢掉**

参数如下所示：

| color  | min_th | max_th | mxp_inv |
| ------ | ------ | ------ | ------- |
| GREEN  | 62     | 63     | 10      |
| YELLOW | 62     | 63     | 10      |
| RED    | 0      | 1      | 10      |

结果如下所示：

![image-20210409223422182](C:\Users\荣耀\Desktop\云计算系统设计与开发\Computer-Network-Lab\Lab3\518021910269.assets\image-20210409223422182.png)

结论：由于限制了绿色和黄色包的长度，使得较长的绿色和黄色包也被丢掉，所以整体的通过率降低了。



**策略三：所有颜色包全部进入队列**

参数如下所示：

| color  | min_th | max_th | mxp_inv |
| ------ | ------ | ------ | ------- |
| GREEN  | 1022   | 1023   | 10      |
| YELLOW | 1022   | 1023   | 10      |
| RED    | 1022   | 1023   | 10      |

结果如下所示：

![image-20210409223610242](C:\Users\荣耀\Desktop\云计算系统设计与开发\Computer-Network-Lab\Lab3\518021910269.assets\image-20210409223610242.png)

结论：由于没有丢包，所以全部通过。



**策略四：所有包部分进入队列**

参数如下所示：

| color  | min_th | max_th | mxp_inv |
| ------ | ------ | ------ | ------- |
| GREEN  | 62     | 63     | 10      |
| YELLOW | 62     | 63     | 10      |
| RED    | 62     | 63     | 10      |

结果如下所示：

![image-20210409223828354](C:\Users\荣耀\Desktop\云计算系统设计与开发\Computer-Network-Lab\Lab3\518021910269.assets\image-20210409223828354.png)

结论：由于所有包都依据包长度进入队列，所以包通过率只和包的长度有关，和其标记的颜色无关



## 我用到的 DPDK API

- `rte_panic`: 检测到错误时报错并终止程序
- `rte_meter_srtcm_config`: 用参数初始化srtcm配置，其余参数分别为带宽,突发尺寸，额外突发尺寸
- `rte_red_config_init`: 用参数初始化red配置，其余参数分别为过滤器权重的对数，最小队列阈值，最大队列阈值,最大标记概率倒数
- `rte_red_rt_data_init`: 用参数初始化red数据
- `rte_meter_srtcm_color_blind_check`: 根据srtcm的配置标记包的颜色,以CBS和EBS作为阈值
- `rte_red_mark_queue_empty`: 清空red算法的包队列
- `rte_red_enqueue`: 根据red的配置决定是进队还是丢包
- `rte_get_tsc_hz`:获得时钟频率
- `rte_get_tsc_cycles`:获得当前的时钟周期